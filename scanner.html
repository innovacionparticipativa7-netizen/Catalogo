<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Escanear cÃ³digo</title>

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111827;
  color: white;
  text-align: center;
  padding: 20px;
}
#barcode-reader {
  width: 320px;
  height: 240px;
  margin: 20px auto;
}
button {
  font-size: 22px;
  padding: 16px 26px;
  border-radius: 12px;
  margin: 8px;
  cursor: pointer;
}
  .btn-principal {
  font-size: 26px;
  padding: 20px 34px;
}

.btn-secundario {
  font-size: 20px;
  padding: 14px 22px;
}


</style>
</head>

<body>

<h2>ğŸ“¦ Escanea el cÃ³digo de barras</h2>

<!-- BOTONES -->
<div style="margin-bottom:20px;">
<button class="btn-principal" onclick="usarLector()">ğŸ“Ÿ Usar lector</button>
<button class="btn-principal" onclick="usarCamara()">ğŸ“· Usar cÃ¡mara</button>

</div>

<!-- INPUT PARA LECTOR -->
<input
  id="barcodeInput"
  type="text"
  inputmode="numeric"
  autocomplete="off"
  style="
    position: fixed;
    top: -1000px;
    left: -1000px;
  "
>


<!-- CÃMARA -->
<div id="barcode-reader" style="display:none;"></div>

<!-- RESULTADO -->
<div id="resultado" style="display:none; margin-top:20px;">
  <h3 id="nombreUsuario"></h3>
  <p>Puntos IP: <strong id="puntosUsuario"></strong></p>

<button class="btn-secundario" onclick="volverAEscanear()">ğŸ”„ Volver a escanear</button>
<button class="btn-secundario" onclick="volver()">â¬… Volver</button>
</div>


<button onclick="cancelar()">âŒ Cancelar</button>

<script>
// ===== FIREBASE =====
firebase.initializeApp({
  apiKey: "AIzaSyCfS-TI8g2KEUWQmCafvf-Ig4KtZa2o_W8",
  authDomain: "catalogo-ee5b7.firebaseapp.com",
  projectId: "catalogo-ee5b7"
});

const db = firebase.firestore();
let modo = null;

// ===== LECTOR =====
function usarLector() {
  modo = "lector";

  document.getElementById("barcode-reader").style.display = "none";
  document.getElementById("resultado").style.display = "none";

  const input = document.getElementById("barcodeInput");
  input.value = "";

  // ğŸ”¥ Forzar foco real
  setTimeout(() => {
    input.focus();
  }, 100);
}
document.getElementById("barcodeInput").addEventListener("keydown", e => {
  if (modo !== "lector") return;

  if (e.key === "Enter") {
    const codigo = e.target.value.trim();
    e.target.value = "";
    buscarUsuario(codigo);
  }
});


// ===== CÃMARA =====
function usarCamara() {
  modo = "camara";
  document.getElementById("resultado").style.display = "none";
  document.getElementById("barcode-reader").style.display = "block";

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector("#barcode-reader"),
      constraints: { facingMode: "environment" }
    },
    decoder: {
      readers: ["code_128_reader", "ean_reader", "ean_8_reader"]
    }
  }, err => {
    if (!err) Quagga.start();
  });
}

Quagga.onDetected(result => {
  if (modo !== "camara") return;
  const codigo = result.codeResult.code;
  Quagga.stop();
  buscarUsuario(codigo);
});

// ===== FIRESTORE =====
function buscarUsuario(codigo) {
  db.collection("usuarios").doc(codigo).get().then(doc => {
    if (!doc.exists) {
      alert("Usuario no encontrado");
      return;
    }

    const data = doc.data();
    document.getElementById("nombreUsuario").textContent = data.nombre;
    document.getElementById("puntosUsuario").textContent = data.puntosActuales;

    document.getElementById("resultado").style.display = "block";
    document.getElementById("barcode-reader").style.display = "none";

    // ğŸ”¥ SI ES LECTOR, mantener foco
    if (modo === "lector") {
      setTimeout(() => {
        document.getElementById("barcodeInput").focus();
      }, 100);
    }
  });
}

  function volverAEscanear() {
  document.getElementById("resultado").style.display = "none";

  if (modo === "lector") {
    const input = document.getElementById("barcodeInput");
    input.value = "";
    input.focus();
  }

  if (modo === "camara") {
    document.getElementById("barcode-reader").style.display = "block";

    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector("#barcode-reader"),
        constraints: { facingMode: "environment" }
      },
      decoder: {
        readers: ["code_128_reader", "ean_reader", "ean_8_reader"]
      }
    }, err => {
      if (!err) Quagga.start();
    });
  }
}


function cancelar() {
  if (window.Quagga) Quagga.stop();
  window.location.href = "index.html";
}

function volver() {
  window.location.href = "index.html";
}
</script>

</body>
</html>







